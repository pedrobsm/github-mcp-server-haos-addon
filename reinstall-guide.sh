#!/bin/bash
# Guia de ReinstalaÃ§Ã£o - GitHub MCP Server Add-on
# ApÃ³s correÃ§Ãµes de bugs

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  GitHub MCP Server Add-on - ReinstalaÃ§Ã£o Corrigida            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âœ… CorreÃ§Ãµes aplicadas:"
echo "  â€¢ Removida dependÃªncia de ghcr.io (build local)"
echo "  â€¢ Ativado acesso Docker API"
echo "  â€¢ Reescrito run.sh sem bashio"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "PASSO 1: Desinstalar versÃ£o antiga (se existir)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "No Home Assistant:"
echo "  1. Ir a: Supervisor â†’ Add-ons"
echo "  2. Encontrar: GitHub MCP Server"
echo "  3. Clicar: Uninstall (se jÃ¡ instalado)"
echo ""
read -p "Pressione ENTER apÃ³s desinstalar (ou se nÃ£o estava instalado)..."
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "PASSO 2: Verificar ficheiros corrigidos"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Verificar se as correÃ§Ãµes foram aplicadas
if grep -q '"docker_api": true' config.json; then
    echo "âœ… config.json - docker_api: true"
else
    echo "âŒ config.json - docker_api ainda false!"
fi

if grep -q '"image"' config.json; then
    echo "âŒ config.json - ainda tem referÃªncia 'image'"
else
    echo "âœ… config.json - sem referÃªncia a 'image'"
fi

if head -1 run.sh | grep -q "#!/bin/bash"; then
    echo "âœ… run.sh - usa bash normal"
else
    echo "âŒ run.sh - ainda usa bashio!"
fi

if grep -q "/data/options.json" run.sh; then
    echo "âœ… run.sh - lÃª configuraÃ§Ã£o de JSON"
else
    echo "âŒ run.sh - nÃ£o lÃª options.json!"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "PASSO 3: Copiar para Home Assistant (se necessÃ¡rio)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Se estÃ¡ a executar localmente, precisa copiar para HAOS:"
echo ""
echo "  scp -r /addons/github-mcp-server root@homeassistant.local:/addons/"
echo ""
echo "Se JÃ estÃ¡ no HAOS, nÃ£o precisa fazer nada."
echo ""
read -p "Pressione ENTER para continuar..."
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "PASSO 4: Recarregar add-ons no Home Assistant"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "No Home Assistant:"
echo "  1. Supervisor â†’ Add-on Store"
echo "  2. Clicar no menu (â‹®) no canto superior direito"
echo "  3. Selecionar: 'Check for updates'"
echo "  4. Aguardar reload..."
echo ""
read -p "Pressione ENTER apÃ³s reload..."
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "PASSO 5: Instalar add-on"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "No Home Assistant:"
echo "  1. Scroll down atÃ© 'Local add-ons' section"
echo "  2. Encontrar: 'GitHub MCP Server'"
echo "  3. Clicar no add-on"
echo "  4. Clicar: INSTALL"
echo ""
echo "â³ AGUARDAR BUILD (pode demorar 3-5 minutos)"
echo ""
echo "Durante o build, verÃ¡ mensagens como:"
echo "  - Downloading dependencies..."
echo "  - Building Docker image..."
echo "  - Installing Python packages..."
echo ""
read -p "Pressione ENTER apÃ³s instalaÃ§Ã£o completa..."
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "PASSO 6: Configurar token GitHub"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "No add-on instalado:"
echo "  1. Clicar na tab: Configuration"
echo "  2. Inserir configuraÃ§Ã£o:"
echo ""
echo "     github_token: ghp_seu_token_aqui"
echo "     toolsets: repos,issues,pull_requests,projects"
echo "     port: 8080"
echo "     log_level: info"
echo ""
echo "  3. Clicar: SAVE"
echo ""
read -p "Pressione ENTER apÃ³s configurar..."
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "PASSO 7: Iniciar add-on"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "No add-on:"
echo "  1. Ir Ã  tab: Info"
echo "  2. Clicar: START"
echo "  3. Aguardar inicializaÃ§Ã£o (15-30 segundos)"
echo "  4. Ir Ã  tab: Log"
echo "  5. Verificar mensagens:"
echo ""
echo "âœ… Logs esperados:"
echo "  [INFO] Starting GitHub MCP Server..."
echo "  [INFO] Configuration:"
echo "  [INFO]   Toolsets: repos,issues,pull_requests,projects"
echo "  [INFO]   Port: 8080"
echo "  [INFO] Pulling GitHub MCP Server Docker image..."
echo "  [INFO] Starting FastAPI HTTP wrapper..."
echo ""
read -p "Pressione ENTER se logs estÃ£o OK..."
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "PASSO 8: Testar funcionamento"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "No terminal do HAOS (via SSH):"
echo ""
echo "  curl http://localhost:8080/health"
echo ""
echo "âœ… Resposta esperada:"
echo '  {"status":"healthy","docker_accessible":true,"version":"1.0.0"}'
echo ""
read -p "Teste o comando acima e pressione ENTER se funcionou..."
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… INSTALAÃ‡ÃƒO COMPLETA!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ‰ O add-on estÃ¡ instalado e a funcionar!"
echo ""
echo "PrÃ³ximos passos:"
echo "  1. Configurar VSCode (ver: docs/vscode-setup.md)"
echo "  2. Criar SSH tunnel:"
echo "     ssh -L 8080:localhost:8080 root@homeassistant.local"
echo "  3. Testar com GitHub Copilot"
echo ""
echo "ğŸ“š DocumentaÃ§Ã£o:"
echo "  â€¢ LEIAME_PT.md - Guia completo (PT)"
echo "  â€¢ README.md - DocumentaÃ§Ã£o principal (EN)"
echo "  â€¢ BUGFIX.md - Detalhes das correÃ§Ãµes"
echo ""
echo "ğŸ†˜ Problemas?"
echo "  â€¢ Verificar logs: Supervisor â†’ GitHub MCP Server â†’ Log"
echo "  â€¢ Consultar: BUGFIX.md (secÃ§Ã£o Troubleshooting)"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
